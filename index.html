<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benchmark Automotive Ecosystem</title>

  <!-- CDNs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1e40af;
      --bg-light:#f3f4f6;
      --bg-white:#ffffff;
      --text-main:#111827;
      --text-muted:#6b7280;
      --border:#e5e7eb;
      --sidebar-width:280px;
      --panel-width:360px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-light);
      color:var(--text-main);
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* Disclaimer */
    .disclaimer-bar{
      background:#fff7ed;
      color:#9a3412;
      font-size:0.75rem;
      text-align:center;
      padding:6px 10px;
      border-bottom:1px solid #fed7aa;
      flex-shrink:0;
    }

    /* Navbar */
    header{
      background:var(--bg-white);
      border-bottom:1px solid var(--border);
      padding:0.75rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:60px;
      flex-shrink:0;
      gap:12px;
    }
    .brand{
      font-weight:800;
      font-size:1.05rem;
      display:flex;
      align-items:center;
      gap:0.5rem;
      white-space:nowrap;
    }
    .brand .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--primary);
      display:inline-block;
    }
    .brand span{color:var(--primary);}
    .nav-controls{
      display:flex;
      gap:0.75rem;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    input[type="text"]{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:0.9rem;
      width:260px;
      background:#fff;
    }
    .view-switch{
      display:flex;
      background:var(--bg-light);
      padding:3px;
      border-radius:10px;
      border:1px solid var(--border);
    }
    .view-btn{
      border:none;
      background:transparent;
      padding:7px 12px;
      cursor:pointer;
      font-size:0.85rem;
      border-radius:8px;
      color:var(--text-muted);
      font-weight:600;
      transition:all .15s;
      white-space:nowrap;
    }
    .view-btn.active{
      background:var(--bg-white);
      color:var(--primary);
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:0.85rem;
      font-weight:700;
      white-space:nowrap;
    }
    .btn-primary:hover{background:var(--primary-dark);}
    .btn-secondary{
      background:#fff;
      color:var(--text-main);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:0.85rem;
      font-weight:800;
      white-space:nowrap;
    }
    .btn-secondary:hover{background:#f9fafb;}

    /* Layout */
    .main-container{
      display:flex;
      flex:1;
      overflow:hidden;
      min-height:0;
    }

    /* Left Sidebar */
    aside.filters{
      width:var(--sidebar-width);
      background:var(--bg-white);
      border-right:1px solid var(--border);
      padding:1.25rem;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:1.25rem;
      flex-shrink:0;
      min-height:0;
    }
    .filter-group h4{
      margin:0 0 0.5rem 0;
      font-size:0.8rem;
      text-transform:uppercase;
      color:var(--text-muted);
      letter-spacing:0.08em;
    }
    .checkbox-group{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .checkbox-item{
      display:flex;
      align-items:center;
      gap:0.5rem;
      font-size:0.9rem;
      cursor:pointer;
      user-select:none;
    }
    select{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }
    .help{
      color:var(--text-muted);
      font-size:0.75rem;
      line-height:1.3;
    }
    .range-wrap{
      padding:0 2px;
    }

    /* Main */
    main{
      flex:1;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      min-height:0;
    }
    .view-container{
      flex:1;
      overflow:hidden;
      position:relative;
      display:none;
      min-height:0;
    }
    .view-container.active{display:block;}
    .view-container.flex-view{
      display:flex;
      flex-direction:column;
      padding:1rem;
      gap:1rem;
      overflow-y:auto;
      min-height:0;
    }

    /* Table */
    .table-wrapper{
      background:var(--bg-white);
      border-radius:12px;
      border:1px solid var(--border);
      overflow:auto;
      height:100%;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
      min-width:900px;
    }
    th{
      background:#f9fafb;
      padding:12px 14px;
      text-align:left;
      border-bottom:1px solid var(--border);
      font-weight:800;
      cursor:pointer;
      position:sticky;
      top:0;
      z-index:10;
      white-space:nowrap;
    }
    td{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    tr:hover{background:#f9fafb; cursor:pointer;}
    tr.selected{background:#eff6ff;}
    .tag-pill{
      display:inline-block;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
      margin:2px 4px 0 0;
      color:#1f2937;
      white-space:nowrap;
    }
    .muted{color:var(--text-muted); font-size:0.82rem;}

    /* Map */
    #map{
      width:100%;
      height:100%;
      background:#e5e5e5;
    }
    .custom-div-icon{
      background:white;
      border:2px solid var(--primary);
      color:var(--primary);
      font-weight:800;
      border-radius:999px;
      display:flex;
      justify-content:center;
      align-items:center;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
    }
    .map-legend{
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:0.8rem;
      z-index:500;
      max-width:260px;
    }
    .legend-row{display:flex; align-items:center; gap:8px; margin:4px 0;}
    .swatch{width:10px; height:10px; border-radius:50%; display:inline-block;}

    /* Charts */
    .charts-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      gap:1rem;
      height:100%;
      padding:1rem;
      box-sizing:border-box;
    }
    .chart-card{
      background:var(--bg-white);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1rem;
      position:relative;
      min-height:240px;
    }
    .chart-card:nth-child(3){grid-column:span 2;}
    .chart-title{
      font-size:0.85rem;
      font-weight:800;
      color:var(--text-muted);
      letter-spacing:0.02em;
      margin:0 0 10px 0;
      text-transform:uppercase;
    }

    /* Network */
    #network-container{
      width:100%;
      height:100%;
      background:#f8fafc;
      position:relative;
    }
    .network-legend{
      position:absolute;
      bottom:10px;
      left:10px;
      background:rgba(255,255,255,.92);
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:0.8rem;
      pointer-events:none;
      max-width:280px;
    }
    .network-toolbar{
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(255,255,255,.92);
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      z-index:2;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size:0.85rem;
    }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .chip input{cursor:pointer;}

    /* Right Panel */
    aside.details-panel{
      width:var(--panel-width);
      border-left:1px solid var(--border);
      padding:0;
      background:#f9fafb;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .empty-state{
      text-align:center;
      margin-top:40%;
      transform:translateY(-50%);
      color:var(--text-muted);
      padding:0 20px;
    }
    .panel-header{
      background:var(--bg-white);
      padding:1.25rem;
      border-bottom:1px solid var(--border);
    }
    .entity-avatar{
      width:52px;height:52px;
      background:var(--primary);
      color:#fff;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:1.05rem;
      margin-bottom:0.75rem;
      letter-spacing:0.05em;
    }
    .panel-content{
      padding:1.25rem;
      overflow-y:auto;
      flex:1;
      min-height:0;
    }
    .panel-section{margin-bottom:1.1rem;}
    .panel-section h5{
      margin:0 0 0.5rem 0;
      color:var(--text-muted);
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .panel-section p{
      margin:0;
      font-size:0.9rem;
      line-height:1.5;
    }
    .assistant-box{
      background:#eff6ff;
      border:1px solid #bfdbfe;
      border-radius:12px;
      padding:1rem;
      margin-top:0.25rem;
    }
    .assistant-title{
      display:flex;
      align-items:center;
      gap:0.5rem;
      font-weight:900;
      color:var(--primary-dark);
      margin-bottom:0.5rem;
      font-size:0.9rem;
    }
    .assistant-content{
      font-size:0.85rem;
      color:#1e3a8a;
      line-height:1.45;
    }
    .source-link{
      font-size:0.82rem;
      color:var(--text-muted);
      display:block;
      margin-top:6px;
      text-decoration:none;
      word-break:break-word;
    }
    .source-link:hover{text-decoration:underline;}

    /* Badges */
    .badge{
      padding:3px 8px;
      border-radius:999px;
      font-size:0.75rem;
      font-weight:900;
      border:1px solid var(--border);
      display:inline-block;
      white-space:nowrap;
    }
    .badge.OEM{ background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }
    .badge.Tier1{ background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .badge.Tier2{ background:#fef3c7; color:#92400e; border-color:#fde68a; }
    .badge.Battery{ background:#ede9fe; color:#5b21b6; border-color:#ddd6fe; }
    .badge.Software{ background:#ffe4e6; color:#9f1239; border-color:#fecdd3; }
    .badge.Charging{ background:#cffafe; color:#155e75; border-color:#a5f3fc; }
    .badge.Mobility{ background:#e0e7ff; color:#3730a3; border-color:#c7d2fe; }
    .badge.Other{ background:#f3f4f6; color:#374151; }

    @media (max-width: 1180px){
      aside.details-panel{display:none;}
      input[type="text"]{width:180px;}
      aside.filters{width:260px;}
    }
    <style>
  /* ... tes styles existants ... */

  /* ===== Mobile (<= 900px) ===== */
  @media (max-width: 900px) {
    :root{
      --sidebar-width: 100vw;
      --panel-width: 100vw;
    }

    header{
      height:auto;
      padding:12px;
      flex-wrap:wrap;
      gap:10px;
    }

    input[type="text"]{
      width: 100%;
      max-width: none;
    }

    aside.filters{ display:none; }
    aside.details-panel{ display:none; }

    table{ min-width: 720px; }

    .view-switch{
      width:100%;
      justify-content:space-between;
    }

    .btn-primary{ width:100%; }
  }
  </style>
</head>

<body>
  <div class="disclaimer-bar">
    DEMO DATASET (illustratif). Remplacez les objets DATA/RELATIONS par des sources vérifiées pour un usage production. Aucune information financière ou relationnelle n’est à considérer comme officielle.
  </div>

  <header>
    <div class="brand"><span class="dot"></span><span>Automotive</span>&nbsp;Benchmark Assistant</div>
    <div class="nav-controls">
      <input type="text" id="search-input" placeholder="Rechercher un acteur, un tag…"/>
      <div class="view-switch" role="tablist" aria-label="Views">
        <button class="view-btn active" data-view="table">Table</button>
        <button class="view-btn" data-view="map">Map</button>
        <button class="view-btn" data-view="charts">Charts</button>
        <button class="view-btn" data-view="network">Network</button>
      </div>

      <button class="btn-secondary" id="btn-reset">Reset</button>
      <button class="btn-primary" id="btn-import-data">Import DATA</button>
      <button class="btn-primary" id="btn-import-rel">Import REL</button>
      <button class="btn-primary" id="btn-export">Export CSV</button>
    </div>
  </header>

  <div class="main-container">
    <!-- Sidebar Filters -->
    <aside class="filters">
      <div class="filter-group">
        <h4>Type d’acteur</h4>
        <div class="checkbox-group" id="filter-type"></div>
      </div>

      <div class="filter-group">
        <h4>Couverture pays</h4>
        <select id="filter-country" multiple size="6"></select>
        <div class="help">Maintenez Ctrl/Cmd pour sélectionner plusieurs pays.</div>
      </div>

      <div class="filter-group">
        <h4>Granularité (Map/Table)</h4>
        <select id="filter-granularity">
          <option value="city">Ville (détail)</option>
          <option value="country">Pays (agrégé)</option>
          <option value="world">Monde (agrégé)</option>
        </select>
      </div>

      <div class="filter-group">
        <h4>CA estimé (min)</h4>
        <div class="range-wrap">
          <input type="range" id="filter-revenue" min="0" max="500" value="0" step="10" style="width:100%"/>
          <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-muted);margin-top:6px;">
            <span>0</span>
            <span id="rev-display">&ge; 0 M€</span>
            <span>500</span>
          </div>
          <div class="help">Les entités sans estimation de CA (null) ne sont pas exclues par ce filtre.</div>
        </div>
      </div>

      <div class="filter-group">
        <h4>Tags fonctionnels</h4>
        <select id="filter-tags" multiple size="8"></select>
        <div class="help">Filtre “AND” : l’acteur doit contenir tous les tags sélectionnés.</div>
      </div>

      <div class="filter-group">
        <h4>Import (formats attendus)</h4>
        <div class="help">
          <strong>Import DATA</strong> : JSON array d’objets ({id,name,actorType,countryCoverage,functionalTags,financials,geo,...}).<br>
          <strong>Import REL</strong> : JSON array ({sourceId,targetId,relationType,weight?,note?}).<br>
          Astuce : commencez par coller un petit dataset (10–30 items) pour tester.
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main>
      <!-- Table View -->
      <div id="view-table" class="view-container active">
        <div class="table-wrapper">
          <table id="benchmark-table">
            <thead>
              <tr>
                <th data-sort="name">Nom</th>
                <th data-sort="actorType">Type</th>
                <th>HQ</th>
                <th>Couverture</th>
                <th>Tags clés</th>
                <th data-sort="revenue">CA (est.)</th>
                <th data-sort="share">Mkt share (est.)</th>
                <th>Confiance</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Map View -->
      <div id="view-map" class="view-container">
        <div class="map-legend" id="map-legend"></div>
        <div id="map"></div>
      </div>

      <!-- Charts View -->
      <div id="view-charts" class="view-container">
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">Acteurs par type</div>
            <canvas id="chart-type"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Couverture pays (Top 10)</div>
            <canvas id="chart-country"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">CA vs part de marché (acteurs avec données)</div>
            <canvas id="chart-scatter"></canvas>
          </div>
        </div>
      </div>

      <!-- Network View -->
      <div id="view-network" class="view-container">
        <div id="network-container">
          <div class="network-toolbar" id="network-toolbar">
            <span class="muted" style="font-weight:800;">Filtrer liens :</span>
            <label class="chip"><input type="checkbox" value="competes_with" checked/>competes_with</label>
            <label class="chip"><input type="checkbox" value="supplies_to" checked/>supplies_to</label>
            <label class="chip"><input type="checkbox" value="partner_of" checked/>partner_of</label>
            <label class="chip"><input type="checkbox" value="integrates_with" checked/>integrates_with</label>
            <label class="chip"><input type="checkbox" value="comparable_to" checked/>comparable_to</label>
          </div>
          <div class="network-legend">
            <div style="font-weight:900;margin-bottom:6px;">Réseau (démo)</div>
            <div class="muted">Nœuds = acteurs. Liens = relations (fourniture, partenariat, concurrence, etc.). Cliquez un nœud pour afficher l’analyse.</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Panel -->
    <aside class="details-panel">
      <div id="panel-empty" class="empty-state">
        <p style="margin:0 0 8px 0; font-weight:900;">Sélectionnez un acteur</p>
        <p style="margin:0;">Cliquez une ligne, un marker ou un nœud pour afficher la fiche et l’explication.</p>
      </div>

      <div id="panel-content" style="display:none; height:100%; flex-direction:column;">
        <div class="panel-header">
          <div class="entity-avatar" id="detail-avatar">AA</div>
          <h2 style="margin:0; font-size:1.25rem; line-height:1.2;" id="detail-name">Nom</h2>
          <div style="margin-top:8px;">
            <span class="badge" id="detail-type">Type</span>
            <span class="muted" id="detail-hq" style="display:inline-block; margin-left:8px;"></span>
          </div>
        </div>

        <div class="panel-content">
          <div class="panel-section">
            <h5>Description</h5>
            <p id="detail-desc"></p>
            <a href="#" target="_blank" rel="noreferrer" id="detail-web" style="display:block; margin-top:0.5rem; font-size:0.9rem; font-weight:800; color:var(--primary); text-decoration:none;">Site web</a>
          </div>

          <div class="panel-section">
            <h5>Tags</h5>
            <div id="detail-tags" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
          </div>

          <div class="panel-section">
            <h5>Indicateurs (illustratifs)</h5>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:0.9rem;">
              <div>
                <span class="muted" style="display:block; font-size:0.75rem;">CA estimé</span>
                <strong id="detail-rev">N/A</strong>
              </div>
              <div>
                <span class="muted" style="display:block; font-size:0.75rem;">Part de marché est.</span>
                <strong id="detail-share">N/A</strong>
              </div>
            </div>
            <div class="muted" style="margin-top:6px; font-size:0.78rem;">
              Confiance : <span id="detail-conf" style="font-weight:900;">low</span>
            </div>
          </div>

          <div class="assistant-box">
            <div class="assistant-title">Assistant de benchmark (démo)</div>
            <div class="assistant-content" id="assistant-text"></div>
          </div>

          <div class="panel-section" style="margin-top:1.25rem;">
            <h5>Sources (placeholders)</h5>
            <div id="detail-sources"></div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // =========================
    // 1) DATA MODEL (Editable)
    // =========================
    // NOTE: dataset illustratif. Ne pas interpréter comme données officielles.
    let DATA = [
      {
        id: "oem_tesla",
        name: "Tesla",
        actorType: "OEM",
        countryCoverage: ["US", "EU", "CN"],
        website: "https://www.tesla.com",
        description: "Constructeur orienté véhicules électriques et architecture logicielle (illustratif).",
        functionalTags: ["EV", "Software", "OTA", "Battery", "Charging ecosystem"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Austin", hqCountry: "US", lat: 30.2672, lng: -97.7431 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Company website (placeholder)", url: "https://example.com" }]
      },
      {
        id: "oem_toyota",
        name: "Toyota",
        actorType: "OEM",
        countryCoverage: ["JP", "US", "EU"],
        website: "https://global.toyota",
        description: "Constructeur mondial (hybride/EV) avec empreinte industrielle large (illustratif).",
        functionalTags: ["OEM", "Hybrid", "EV", "Manufacturing scale"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Toyota City", hqCountry: "JP", lat: 35.0830, lng: 137.1560 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Corporate profile (placeholder)", url: "https://example.com" }]
      },
      {
        id: "oem_volkswagen",
        name: "Volkswagen Group",
        actorType: "OEM",
        countryCoverage: ["DE", "EU", "CN", "US"],
        website: "https://www.volkswagenag.com",
        description: "Groupe OEM multi-marques avec initiatives EV/SDV (illustratif).",
        functionalTags: ["OEM", "EV", "Platform strategy", "SDV"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Wolfsburg", hqCountry: "DE", lat: 52.4227, lng: 10.7865 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Annual report (placeholder)", url: "https://example.com" }]
      },
      {
        id: "tier1_bosch",
        name: "Bosch",
        actorType: "Tier1",
        countryCoverage: ["DE", "EU", "US", "CN"],
        website: "https://www.bosch.com",
        description: "Équipementier : ADAS, capteurs, électronique de puissance, services mobilité (illustratif).",
        functionalTags: ["ADAS", "Sensors", "Power Electronics", "Mobility services", "Manufacturing"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Gerlingen", hqCountry: "DE", lat: 48.7990, lng: 9.0640 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Company facts (placeholder)", url: "https://example.com" }]
      },
      {
        id: "tier1_continental",
        name: "Continental",
        actorType: "Tier1",
        countryCoverage: ["DE", "EU", "US", "CN"],
        website: "https://www.continental.com",
        description: "Équipementier : cockpit, ADAS, pneus et électronique automobile (illustratif).",
        functionalTags: ["ADAS", "Cockpit", "Tires", "Sensors"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Hanover", hqCountry: "DE", lat: 52.3759, lng: 9.7320 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Investor relations (placeholder)", url: "https://example.com" }]
      },
      {
        id: "tier1_valeo",
        name: "Valeo",
        actorType: "Tier1",
        countryCoverage: ["FR", "EU", "US", "CN"],
        website: "https://www.valeo.com",
        description: "Équipementier : assistance à la conduite, électrification, lighting (illustratif).",
        functionalTags: ["ADAS", "Electrification", "Lighting", "Thermal"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Paris", hqCountry: "FR", lat: 48.8566, lng: 2.3522 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Company profile (placeholder)", url: "https://example.com" }]
      },
      {
        id: "battery_catl",
        name: "CATL",
        actorType: "Battery",
        countryCoverage: ["CN", "EU"],
        website: "https://www.catl.com",
        description: "Fabricant cellules batteries et supply chain EV (illustratif).",
        functionalTags: ["Battery cells", "EV supply chain", "Energy storage"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Ningde", hqCountry: "CN", lat: 26.6656, lng: 119.5480 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Company site (placeholder)", url: "https://example.com" }]
      },
      {
        id: "battery_lges",
        name: "LG Energy Solution",
        actorType: "Battery",
        countryCoverage: ["KR", "EU", "US"],
        website: "https://www.lgensol.com",
        description: "Acteur batteries EV (cellules/packs) (illustratif).",
        functionalTags: ["Battery cells", "Battery packs", "Gigafactory"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Seoul", hqCountry: "KR", lat: 37.5665, lng: 126.9780 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "IR (placeholder)", url: "https://example.com" }]
      },
      {
        id: "software_blackberry_qnx",
        name: "BlackBerry QNX",
        actorType: "Software",
        countryCoverage: ["CA", "US", "EU"],
        website: "https://blackberry.qnx.com",
        description: "OS embarqué pour systèmes automobiles (illustratif).",
        functionalTags: ["Embedded OS", "Infotainment", "Safety", "SDV"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Ottawa", hqCountry: "CA", lat: 45.4215, lng: -75.6972 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Product page (placeholder)", url: "https://example.com" }]
      },
      {
        id: "software_autosar",
        name: "AUTOSAR (Consortium)",
        actorType: "Software",
        countryCoverage: ["EU", "US", "JP"],
        website: "https://www.autosar.org",
        description: "Standardisation logicielle pour l’automobile (illustratif).",
        functionalTags: ["Middleware", "Standard", "ECU", "SDV"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Munich", hqCountry: "DE", lat: 48.1351, lng: 11.5820 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Consortium site (placeholder)", url: "https://example.com" }]
      },
      {
        id: "charging_ionity",
        name: "IONITY",
        actorType: "Charging",
        countryCoverage: ["EU"],
        website: "https://ionity.eu",
        description: "Réseau HPC (recharge haute puissance) en Europe (illustratif).",
        functionalTags: ["Charging", "HPC", "EV infrastructure"],
        financials: { revenueEstimateEUR: null, marketShareEstimate: null, confidence: "low", sources: [] },
        geo: { hqCity: "Munich", hqCountry: "DE", lat: 48.1351, lng: 11.5820 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Network info (placeholder)", url: "https://example.com" }]
      },
      {
        id: "mobility_leaseco",
        name: "LeaseCo (Demo Mobility)",
        actorType: "Mobility",
        countryCoverage: ["FR", "EU"],
        website: "",
        description: "Acteur mobilité/leasing (démo) pour illustrer la chaîne de valeur (illustratif).",
        functionalTags: ["Leasing", "Fleet", "Aftermarket", "Mobility services"],
        financials: { revenueEstimateEUR: 120, marketShareEstimate: 2.0, confidence: "low", sources: [] },
        geo: { hqCity: "Paris", hqCountry: "FR", lat: 48.8660, lng: 2.3330 },
        status: "Illustrative",
        lastUpdated: "2026-01-11",
        sources: [{ label: "Market note (placeholder)", url: "https://example.com" }]
      }
    ];

    // RELATIONS: sourceId/targetId must match DATA.id
    let RELATIONS = [
      { sourceId:"tier1_bosch", targetId:"oem_toyota", relationType:"supplies_to", weight:4, note:"Tier-1 supply chain (illustratif)" },
      { sourceId:"tier1_bosch", targetId:"oem_volkswagen", relationType:"supplies_to", weight:4, note:"Tier-1 supply chain (illustratif)" },
      { sourceId:"tier1_continental", targetId:"oem_volkswagen", relationType:"supplies_to", weight:4, note:"Tier-1 supply chain (illustratif)" },
      { sourceId:"tier1_valeo", targetId:"oem_toyota", relationType:"supplies_to", weight:3, note:"Tier-1 supply chain (illustratif)" },
      { sourceId:"tier1_valeo", targetId:"oem_volkswagen", relationType:"supplies_to", weight:3, note:"Tier-1 supply chain (illustratif)" },

      { sourceId:"battery_catl", targetId:"oem_tesla", relationType:"supplies_to", weight:3, note:"Battery supply (illustratif)" },
      { sourceId:"battery_lges", targetId:"oem_tesla", relationType:"supplies_to", weight:3, note:"Battery supply (illustratif)" },
      { sourceId:"battery_catl", targetId:"oem_volkswagen", relationType:"supplies_to", weight:4, note:"Battery supply (illustratif)" },
      { sourceId:"battery_lges", targetId:"oem_toyota", relationType:"supplies_to", weight:2, note:"Battery supply (illustratif)" },

      { sourceId:"software_blackberry_qnx", targetId:"tier1_bosch", relationType:"integrates_with", weight:3, note:"Embedded OS integration (illustratif)" },
      { sourceId:"software_blackberry_qnx", targetId:"tier1_continental", relationType:"integrates_with", weight:3, note:"Embedded OS integration (illustratif)" },
      { sourceId:"software_autosar", targetId:"tier1_bosch", relationType:"integrates_with", weight:4, note:"Standard/middleware alignment (illustratif)" },
      { sourceId:"software_autosar", targetId:"tier1_valeo", relationType:"integrates_with", weight:4, note:"Standard/middleware alignment (illustratif)" },

      { sourceId:"charging_ionity", targetId:"oem_volkswagen", relationType:"partner_of", weight:4, note:"Ecosystem partnership (illustratif)" },
      { sourceId:"charging_ionity", targetId:"oem_tesla", relationType:"competes_with", weight:2, note:"Charging ecosystem overlap (illustratif)" },

      { sourceId:"tier1_bosch", targetId:"tier1_continental", relationType:"competes_with", weight:4, note:"ADAS/electronics competition (illustratif)" },
      { sourceId:"tier1_continental", targetId:"tier1_valeo", relationType:"competes_with", weight:3, note:"ADAS/cockpit overlap (illustratif)" },
      { sourceId:"battery_catl", targetId:"battery_lges", relationType:"competes_with", weight:4, note:"Battery competition (illustratif)" },
      { sourceId:"oem_tesla", targetId:"oem_volkswagen", relationType:"competes_with", weight:4, note:"OEM competition (illustratif)" },
      { sourceId:"oem_toyota", targetId:"oem_volkswagen", relationType:"competes_with", weight:3, note:"OEM competition (illustratif)" },

      { sourceId:"oem_tesla", targetId:"oem_toyota", relationType:"comparable_to", weight:2, note:"Comparable at macro level (illustratif)" },
      { sourceId:"tier1_bosch", targetId:"tier1_valeo", relationType:"comparable_to", weight:2, note:"Comparable at macro level (illustratif)" }
    ];

    // =========================
    // 2) APP STATE
    // =========================
    let ACTOR_TYPES = [];
    recomputeActorTypes();

    const APP = {
      currentView: "table",
      selectedEntityId: null,
      filters: {
        search: "",
        types: [],       // will be reset to all actor types
        countries: [],
        tags: [],
        revenueMin: 0,
        granularity: "city"
      },
      filteredData: [],
      instances: {
        map: null,
        mapLayerGroup: null,
        charts: [],
        simulation: null
      }
    };

    // =========================
    // 3) INIT
    // =========================
    document.addEventListener("DOMContentLoaded", () => {
      initFilters(true);
      bindUI();
      applyFilters();

      // Select sensible default
      if (DATA.length > 0) selectEntity(DATA[0].id);
    });

    function bindUI(){
      // View switch
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".view-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          APP.currentView = btn.dataset.view;
          updateViewVisibility();
        });
      });

      // Search
      document.getElementById("search-input").addEventListener("input", (e) => {
        APP.filters.search = (e.target.value || "").toLowerCase().trim();
        applyFilters();
      });

      // Revenue slider
      document.getElementById("filter-revenue").addEventListener("input", (e) => {
        const val = parseInt(e.target.value, 10);
        APP.filters.revenueMin = isNaN(val) ? 0 : val;
        document.getElementById("rev-display").textContent = `≥ ${APP.filters.revenueMin} M€`;
        applyFilters();
      });

      // Granularity
      document.getElementById("filter-granularity").addEventListener("change", () => {
        APP.filters.granularity = document.getElementById("filter-granularity").value;
        applyFilters();
      });

      // Export
      document.getElementById("btn-export").addEventListener("click", exportCSV);

      // Reset
      document.getElementById("btn-reset").addEventListener("click", () => {
        resetAppStateAndUI();
        applyFilters();
        if (DATA.length > 0) selectEntity(DATA[0].id);
      });

      // Import DATA
      document.getElementById("btn-import-data").addEventListener("click", importDATA);

      // Import RELATIONS
      document.getElementById("btn-import-rel").addEventListener("click", importRELATIONS);

      // Sort headers
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.addEventListener("click", () => sortTable(th.dataset.sort));
      });

      // Network link filters
      document.querySelectorAll("#network-toolbar input[type='checkbox']").forEach(cb => {
        cb.addEventListener("change", () => {
          if (APP.currentView === "network") renderNetwork();
        });
      });
    }

    function recomputeActorTypes(){
      ACTOR_TYPES = Array.from(new Set(DATA.map(d => d.actorType))).sort();
      // Ensure we always have a fallback for styles/palette
      if (ACTOR_TYPES.length === 0) ACTOR_TYPES = ["Other"];
    }

    function initFilters(resetAllSelections){
      // Types checkboxes
      const typeContainer = document.getElementById("filter-type");
      typeContainer.innerHTML = "";

      if (resetAllSelections) {
        APP.filters.types = [...ACTOR_TYPES];
      } else {
        // Keep existing selected types if possible
        const current = new Set(APP.filters.types || []);
        const merged = ACTOR_TYPES.filter(t => current.has(t));
        APP.filters.types = merged.length ? merged : [...ACTOR_TYPES];
      }

      ACTOR_TYPES.forEach(type => {
        const div = document.createElement("div");
        div.className = "checkbox-item";
        const checked = APP.filters.types.includes(type) ? "checked" : "";
        div.innerHTML = `
          <input type="checkbox" ${checked} value="${escapeHtml(type)}"/>
          <span class="badge ${escapeHtml(type)}">${escapeHtml(type)}</span>
        `;
        div.querySelector("input").addEventListener("change", updateFilters);
        typeContainer.appendChild(div);
      });

      // Countries multi-select
      const allCountries = new Set();
      DATA.forEach(d => (d.countryCoverage || []).forEach(c => allCountries.add(c)));
      const countrySelect = document.getElementById("filter-country");
      const keepCountries = new Set(APP.filters.countries || []);
      countrySelect.innerHTML = "";
      Array.from(allCountries).sort().forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if (!resetAllSelections && keepCountries.has(c)) opt.selected = true;
        countrySelect.appendChild(opt);
      });
      countrySelect.removeEventListener("change", updateFilters);
      countrySelect.addEventListener("change", updateFilters);

      // Tags multi-select
      const allTags = new Set();
      DATA.forEach(d => (d.functionalTags || []).forEach(t => allTags.add(t)));
      const tagSelect = document.getElementById("filter-tags");
      const keepTags = new Set(APP.filters.tags || []);
      tagSelect.innerHTML = "";
      Array.from(allTags).sort().forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (!resetAllSelections && keepTags.has(t)) opt.selected = true;
        tagSelect.appendChild(opt);
      });
      tagSelect.removeEventListener("change", updateFilters);
      tagSelect.addEventListener("change", updateFilters);

      // Map legend
      renderMapLegend();
    }

    function updateFilters(){
      APP.filters.types = Array.from(document.querySelectorAll("#filter-type input:checked")).map(cb => cb.value);
      APP.filters.countries = Array.from(document.getElementById("filter-country").selectedOptions).map(o => o.value);
      APP.filters.tags = Array.from(document.getElementById("filter-tags").selectedOptions).map(o => o.value);
      APP.filters.granularity = document.getElementById("filter-granularity").value;
      applyFilters();
    }

    function applyFilters(){
      const search = APP.filters.search;
      const minRev = APP.filters.revenueMin;

      APP.filteredData = DATA.filter(d => {
        // Type
        if (!APP.filters.types.includes(d.actorType)) return false;

        // Country OR logic
        if (APP.filters.countries.length > 0) {
          const okCountry = (d.countryCoverage || []).some(c => APP.filters.countries.includes(c));
          if (!okCountry) return false;
        }

        // Tags AND logic
        if (APP.filters.tags.length > 0) {
          const tagSet = new Set(d.functionalTags || []);
          const okTags = APP.filters.tags.every(t => tagSet.has(t));
          if (!okTags) return false;
        }

        // Revenue min: do not exclude null
        const rev = (d.financials && typeof d.financials.revenueEstimateEUR === "number") ? d.financials.revenueEstimateEUR : null;
        if (rev !== null && rev < minRev) return false;

        // Search
        if (search) {
          const s = `${d.name} ${(d.functionalTags||[]).join(" ")} ${(d.actorType||"")} ${(d.geo?.hqCity||"")} ${(d.geo?.hqCountry||"")}`.toLowerCase();
          if (!s.includes(search)) return false;
        }

        return true;
      });

      renderCurrentView();

      // If selected entity is filtered out, clear panel
      if (APP.selectedEntityId && !APP.filteredData.some(x => x.id === APP.selectedEntityId)) {
        APP.selectedEntityId = null;
        showEmptyPanel();
      }
    }

    function updateViewVisibility(){
      document.querySelectorAll(".view-container").forEach(el => el.classList.remove("active"));
      document.getElementById(`view-${APP.currentView}`).classList.add("active");
      renderCurrentView();
    }

    function renderCurrentView(){
      if (APP.currentView === "table") renderTable();
      if (APP.currentView === "map") renderMap();
      if (APP.currentView === "charts") renderCharts();
      if (APP.currentView === "network") renderNetwork();
    }

    function resetAppStateAndUI(){
      // Filters state
      APP.filters.search = "";
      APP.filters.countries = [];
      APP.filters.tags = [];
      APP.filters.revenueMin = 0;
      APP.filters.granularity = "city";
      APP.filters.types = [...ACTOR_TYPES];

      // UI state
      APP.selectedEntityId = null;

      // Reset inputs
      document.getElementById("search-input").value = "";
      document.getElementById("filter-revenue").value = "0";
      document.getElementById("rev-display").textContent = "≥ 0 M€";
      document.getElementById("filter-granularity").value = "city";

      // Reinit filters UI
      initFilters(true);

      // Clear panel
      showEmptyPanel();
    }

    // =========================
    // 4) TABLE
    // =========================
    let currentSort = { field: "name", dir: "asc" };

    function sortTable(field){
      if (currentSort.field === field) {
        currentSort.dir = (currentSort.dir === "asc") ? "desc" : "asc";
      } else {
        currentSort.field = field;
        currentSort.dir = (field === "name" || field === "actorType") ? "asc" : "desc";
      }
      renderTable();
    }

    function renderTable(){
      const tbody = document.getElementById("table-body");
      tbody.innerHTML = "";

      const sorted = [...APP.filteredData].sort((a,b) => {
        const dir = (currentSort.dir === "asc") ? 1 : -1;

        const getVal = (x) => {
          if (currentSort.field === "name") return x.name || "";
          if (currentSort.field === "actorType") return x.actorType || "";
          if (currentSort.field === "revenue") return (typeof x.financials?.revenueEstimateEUR === "number") ? x.financials.revenueEstimateEUR : -1;
          if (currentSort.field === "share") return (typeof x.financials?.marketShareEstimate === "number") ? x.financials.marketShareEstimate : -1;
          return "";
        };

        const va = getVal(a);
        const vb = getVal(b);

        if (typeof va === "number" && typeof vb === "number") {
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return 0;
        }
        return String(va).localeCompare(String(vb)) * dir;
      });

      if (APP.filters.granularity !== "city") {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="8" style="padding:1.2rem; text-align:center; color:var(--text-muted);">
            Granularité "${escapeHtml(APP.filters.granularity)}" active : la carte s’agrège. Le tableau reste en détail pour le benchmark.
          </td>
        `;
        tbody.appendChild(tr);
      }

      if (sorted.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" style="padding:1.5rem; text-align:center; color:var(--text-muted);">Aucun acteur ne correspond aux filtres.</td>`;
        tbody.appendChild(tr);
        return;
      }

      sorted.forEach(item => {
        const tr = document.createElement("tr");
        if (APP.selectedEntityId === item.id) tr.classList.add("selected");
        tr.addEventListener("click", () => selectEntity(item.id));

        const rev = (typeof item.financials?.revenueEstimateEUR === "number") ? `${item.financials.revenueEstimateEUR} M€` : "N/A";
        const share = (typeof item.financials?.marketShareEstimate === "number") ? `${item.financials.marketShareEstimate}%` : "N/A";
        const conf = item.financials?.confidence || "low";
        const hq = `${item.geo?.hqCity || "—"} (${item.geo?.hqCountry || "—"})`;

        const tags = (item.functionalTags || []).slice(0, 4).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join("");

        tr.innerHTML = `
          <td><strong>${escapeHtml(item.name)}</strong></td>
          <td><span class="badge ${escapeHtml(item.actorType)}">${escapeHtml(item.actorType)}</span></td>
          <td>${escapeHtml(hq)}</td>
          <td>${escapeHtml((item.countryCoverage || []).join(", "))}</td>
          <td>${tags}</td>
          <td>${escapeHtml(rev)}</td>
          <td>${escapeHtml(share)}</td>
          <td><span class="badge Other">${escapeHtml(conf)}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // 5) MAP
    // =========================
    function renderMap(){
      if (!APP.instances.map) {
        APP.instances.map = L.map("map", { zoomControl: true }).setView([20, 0], 2);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
          attribution: "&copy; OpenStreetMap &copy; CartoDB"
        }).addTo(APP.instances.map);
        APP.instances.mapLayerGroup = L.layerGroup().addTo(APP.instances.map);
      }

      // Hack for dynamic resize tab switch
      setTimeout(() => APP.instances.map.invalidateSize(), 60);

      APP.instances.mapLayerGroup.clearLayers();

      const g = APP.filters.granularity;
      const safePoints = APP.filteredData
        .map(d => ({...d}))
        .filter(d => typeof d.geo?.lat === "number" && typeof d.geo?.lng === "number");

      if (safePoints.length === 0) return;

      if (g === "city") {
        safePoints.forEach(d => {
          const color = getActorColor(d.actorType);
          const marker = L.circleMarker([d.geo.lat, d.geo.lng], {
            color, fillColor: color, fillOpacity: 0.75, radius: 7, weight: 2
          });
          marker.bindPopup(`
            <div style="font-family:inherit;">
              <div style="font-weight:900;">${escapeHtml(d.name)}</div>
              <div style="margin-top:4px;"><span class="badge ${escapeHtml(d.actorType)}">${escapeHtml(d.actorType)}</span></div>
              <div style="margin-top:6px; color:#6b7280; font-size:12px;">HQ: ${escapeHtml(d.geo.hqCity)} (${escapeHtml(d.geo.hqCountry)})</div>
            </div>
          `);
          marker.on("click", () => selectEntity(d.id));
          marker.addTo(APP.instances.mapLayerGroup);
        });
        fitMapToPoints(safePoints);
      } else {
        // Aggregate
        const agg = {};
        safePoints.forEach(d => {
          const key = d.geo.hqCountry || "—";
          if (!agg[key]) agg[key] = { count: 0, latSum: 0, lngSum: 0, names: [] };
          agg[key].count++;
          agg[key].latSum += d.geo.lat;
          agg[key].lngSum += d.geo.lng;
          agg[key].names.push(d.name);
        });

        Object.keys(agg).forEach(country => {
          const item = agg[country];
          const lat = item.latSum / item.count;
          const lng = item.lngSum / item.count;
          const icon = L.divIcon({
            className: "custom-div-icon",
            html: `<span>${item.count}</span>`,
            iconSize: [34, 34]
          });
          const popupList = item.names.slice(0, 8).map(n => `• ${escapeHtml(n)}`).join("<br>");
          const more = item.names.length > 8 ? `<div style="margin-top:6px; color:#6b7280; font-size:12px;">+ ${item.names.length - 8} autres</div>` : "";
          const m = L.marker([lat, lng], { icon });
          m.bindPopup(`
            <div style="font-family:inherit;">
              <div style="font-weight:900;">${escapeHtml(country)}</div>
              <div style="margin-top:6px; font-size:12px;">${item.count} acteur(s)</div>
              <div style="margin-top:6px; font-size:12px; line-height:1.35;">${popupList}</div>
              ${more}
            </div>
          `);
          m.addTo(APP.instances.mapLayerGroup);
        });

        if (g === "world") APP.instances.map.setView([20, 0], 2);
        else fitMapToPoints(safePoints);
      }
    }

    function fitMapToPoints(points){
      const latLngs = points.map(p => [p.geo.lat, p.geo.lng]);
      const bounds = L.latLngBounds(latLngs);
      APP.instances.map.fitBounds(bounds.pad(0.25));
    }

    function renderMapLegend(){
      const el = document.getElementById("map-legend");
      const rows = ACTOR_TYPES.map(t => `
        <div class="legend-row">
          <span class="swatch" style="background:${getActorColor(t)}"></span>
          <span style="font-weight:900;">${escapeHtml(t)}</span>
        </div>
      `).join("");
      el.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px;">Légende</div>
        ${rows}
        <div class="muted" style="margin-top:8px;">Granularité : Ville = points, Pays/Monde = agrégation par pays.</div>
      `;
    }

    // =========================
    // 6) CHARTS
    // =========================
    function renderCharts(){
      APP.instances.charts.forEach(c => c.destroy());
      APP.instances.charts = [];

      // Type
      const typeCounts = {};
      ACTOR_TYPES.forEach(t => typeCounts[t] = 0);
      APP.filteredData.forEach(d => { typeCounts[d.actorType] = (typeCounts[d.actorType] || 0) + 1; });
      const ctx1 = document.getElementById("chart-type").getContext("2d");
      APP.instances.charts.push(new Chart(ctx1, {
        type: "bar",
        data: {
          labels: Object.keys(typeCounts),
          datasets: [{ label: "Nb d’acteurs", data: Object.values(typeCounts) }]
        },
        options: { responsive:true, maintainAspectRatio:false }
      }));

      // Country
      const countryCounts = {};
      APP.filteredData.forEach(d => {
        (d.countryCoverage || []).forEach(c => countryCounts[c] = (countryCounts[c] || 0) + 1);
      });
      const topCountries = Object.entries(countryCounts).sort((a,b) => b[1]-a[1]).slice(0,10);
      const ctx2 = document.getElementById("chart-country").getContext("2d");
      APP.instances.charts.push(new Chart(ctx2, {
        type: "bar",
        data: {
          labels: topCountries.map(x => x[0]),
          datasets: [{ label: "Fréquence de couverture", data: topCountries.map(x => x[1]) }]
        },
        options: { responsive:true, maintainAspectRatio:false, indexAxis:"y" }
      }));

      // Scatter
      const scatterData = APP.filteredData
        .filter(d => typeof d.financials?.revenueEstimateEUR === "number" && typeof d.financials?.marketShareEstimate === "number")
        .map(d => ({ x: d.financials.revenueEstimateEUR, y: d.financials.marketShareEstimate, label: d.name }));
      const ctx3 = document.getElementById("chart-scatter").getContext("2d");
      APP.instances.charts.push(new Chart(ctx3, {
        type: "scatter",
        data: { datasets: [{ label: "CA (X) vs Part de marché (Y)", data: scatterData }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins: { tooltip: { callbacks: { label: (ctx) => `${ctx.raw.label}: ${ctx.raw.x} M€ / ${ctx.raw.y}%` } } }
        }
      }));
    }

    // =========================
    // 7) NETWORK
    // =========================
    function renderNetwork(){
      const container = document.getElementById("network-container");
      const existing = container.querySelector("svg");
      if (existing) existing.remove();

      const width = container.clientWidth;
      const height = container.clientHeight;

      const nodeIds = new Set(APP.filteredData.map(d => d.id));
      const nodes = APP.filteredData.map(d => ({ id: d.id, group: d.actorType, name: d.name }));

      const enabledTypes = new Set(
        Array.from(document.querySelectorAll("#network-toolbar input[type='checkbox']:checked")).map(x => x.value)
      );

      const links = RELATIONS
        .filter(r => nodeIds.has(r.sourceId) && nodeIds.has(r.targetId))
        .filter(r => enabledTypes.has(r.relationType))
        .map(r => ({
          source: r.sourceId,
          target: r.targetId,
          relationType: r.relationType,
          weight: r.weight || 1,
          note: r.note || ""
        }));

      const svg = d3.select("#network-container").append("svg")
        .attr("width", width).attr("height", height)
        .style("position","absolute").style("inset","0");

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(110))
        .force("charge", d3.forceManyBody().strength(-320))
        .force("center", d3.forceCenter(width/2, height/2));

      const link = svg.append("g")
        .attr("stroke-opacity", 0.85)
        .selectAll("line")
        .data(links).join("line")
        .attr("stroke-width", d => Math.max(1, Math.sqrt(d.weight)))
        .attr("stroke", d => getRelationColor(d.relationType));

      const node = svg.append("g")
        .selectAll("circle")
        .data(nodes).join("circle")
        .attr("r", 10)
        .attr("fill", d => getActorColor(d.group))
        .attr("stroke", "#fff").attr("stroke-width", 1.6)
        .call(drag(simulation));

      node.append("title").text(d => d.name);
      node.on("click", (event, d) => selectEntity(d.id));

      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("cx", d => d.x).attr("cy", d => d.y);
      });

      APP.instances.simulation = simulation;
    }

    function drag(simulation){
      function dragstarted(event){
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }
      function dragged(event){
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }
      function dragended(event){
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
      return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
    }

    // =========================
    // 8) DETAILS + ASSISTANT
    // =========================
    function selectEntity(id){
      APP.selectedEntityId = id;
      const ent = DATA.find(d => d.id === id);
      if (!ent) return;

      if (APP.currentView === "table") renderTable();

      document.getElementById("panel-empty").style.display = "none";
      document.getElementById("panel-content").style.display = "flex";

      document.getElementById("detail-name").textContent = ent.name;
      document.getElementById("detail-type").textContent = ent.actorType;
      document.getElementById("detail-type").className = `badge ${ent.actorType}`;
      document.getElementById("detail-hq").textContent = `${ent.geo?.hqCity || "—"} (${ent.geo?.hqCountry || "—"})`;
      document.getElementById("detail-desc").textContent = ent.description || "—";

      const website = ent.website || "";
      const webEl = document.getElementById("detail-web");
      if (website) {
        webEl.href = website; webEl.textContent = "Site web";
        webEl.style.pointerEvents = "auto"; webEl.style.opacity = "1";
      } else {
        webEl.href = "#"; webEl.textContent = "Aucun site renseigné";
        webEl.style.pointerEvents = "none"; webEl.style.opacity = "0.6";
      }

      // Avatar
      const initials = getInitials(ent.name);
      const av = document.getElementById("detail-avatar");
      av.textContent = initials;
      av.style.background = getActorColor(ent.actorType);

      // Tags
      const tagContainer = document.getElementById("detail-tags");
      tagContainer.innerHTML = (ent.functionalTags || []).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join("");

      // Financials
      const f = ent.financials || {};
      document.getElementById("detail-rev").textContent = (typeof f.revenueEstimateEUR === "number") ? `${f.revenueEstimateEUR} M€` : "N/A";
      document.getElementById("detail-share").textContent = (typeof f.marketShareEstimate === "number") ? `${f.marketShareEstimate}%` : "N/A";
      document.getElementById("detail-conf").textContent = f.confidence || "low";

      // Sources
      const sources = (ent.sources && ent.sources.length) ? ent.sources : [];
      const finSources = (f.sources && f.sources.length) ? f.sources : [];
      const combined = [...sources, ...finSources].slice(0, 6);
      const srcEl = document.getElementById("detail-sources");
      if (combined.length === 0) {
        srcEl.innerHTML = `<div class="muted">Aucune source renseignée dans ce dataset.</div>`;
      } else {
        srcEl.innerHTML = combined.map(s => {
          const label = escapeHtml(s.label || "Source");
          const url = escapeHtml(s.url || "#");
          return `<a class="source-link" href="${url}" target="_blank" rel="noreferrer">${label}</a>`;
        }).join("");
      }

      generateAssistantContent(ent);
    }

    function showEmptyPanel(){
      document.getElementById("panel-empty").style.display = "block";
      document.getElementById("panel-content").style.display = "none";
    }

    function generateAssistantContent(ent){
      const fit = categoryFit(ent);
      const peerIds = getPeerIds(ent.id);
      const peers = peerIds.map(pid => DATA.find(d => d.id === pid)).filter(Boolean).slice(0, 5).map(p => p.name);
      const diff = rareTags(ent, APP.filteredData);
      const caveat = "Attention : dataset illustratif. Les relations et indicateurs nécessitent validation.";

      const html = `
        <div style="margin-bottom:8px;">
          <div style="font-weight:900;margin-bottom:4px;">Positionnement</div>
          <div>${fit}</div>
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:900;margin-bottom:4px;">Pairs proches (Network)</div>
          <div>${peers.length ? `<strong>${escapeHtml(peers.join(", "))}</strong>` : "Aucun pair direct détecté dans RELATIONS."} </div>
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:900;margin-bottom:4px;">Différenciation</div>
          <div>${diff.length ? `Tags relativement distinctifs : <strong>${escapeHtml(diff.join(", "))}</strong>.` : "Différenciation non saillante."} </div>
        </div>
        <div style="border-top:1px dashed #bfdbfe; padding-top:8px; font-size:0.78rem; color:#1f3a8a;">
          ${escapeHtml(caveat)}
        </div>
      `;
      document.getElementById("assistant-text").innerHTML = html;
    }

    function categoryFit(ent){
      const t = ent.actorType;
      if (t === "OEM") return `Acteur <strong>OEM</strong> : comparaison par segments, footprint industriel et capacité SDV.`;
      if (t === "Tier1") return `Acteur <strong>Tier 1</strong> : comparaison via profondeur portefeuille et intégration OEM.`;
      if (t === "Battery") return `Acteur <strong>Batteries</strong> : comparaison via capacité gigafactory et intégration BMS.`;
      if (t === "Software") return `Acteur <strong>Software</strong> : comparaison via adoption et compatibilité middleware.`;
      return `Acteur <strong>${escapeHtml(t)}</strong> : analyse spécifique requise selon contexte.`;
    }

    function getPeerIds(entityId){
      const rel = RELATIONS.filter(r =>
        (r.sourceId === entityId || r.targetId === entityId) &&
        (r.relationType === "competes_with" || r.relationType === "comparable_to")
      );
      const ids = rel.map(r => (r.sourceId === entityId ? r.targetId : r.sourceId));
      return Array.from(new Set(ids));
    }

    function rareTags(ent, scopeData){
      const counts = {};
      scopeData.forEach(d => (d.functionalTags || []).forEach(t => counts[t] = (counts[t] || 0) + 1));
      const tags = ent.functionalTags || [];
      return tags.filter(t => (counts[t] || 0) <= 2).slice(0, 6);
    }

    // =========================
    // 9) IMPORT / EXPORT
    // =========================
    function exportCSV(){
      const headers = ["id","name","actorType","hqCity","hqCountry","countryCoverage","functionalTags","revenueEstimateEUR","marketShareEstimate","confidence"];
      const rows = APP.filteredData.map(d => [
        d.id,
        d.name,
        d.actorType,
        d.geo?.hqCity || "",
        d.geo?.hqCountry || "",
        (d.countryCoverage || []).join("|"),
        (d.functionalTags || []).join("|"),
        (typeof d.financials?.revenueEstimateEUR === "number") ? d.financials.revenueEstimateEUR : "",
        (typeof d.financials?.marketShareEstimate === "number") ? d.financials.marketShareEstimate : "",
        d.financials?.confidence || ""
      ]);

      const csv = [headers.join(","), ...rows.map(r => r.map(csvEscape).join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "automotive_benchmark_export.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function importDATA(){
      const jsonStr = prompt("Collez le tableau JSON des données (format identique à DATA) :");
      if(!jsonStr) return;
      try {
        const parsed = JSON.parse(jsonStr);
        if(!Array.isArray(parsed)) throw new Error("Format invalide: doit être un tableau");
        DATA = parsed;
        recomputeActorTypes();
        initFilters(true); // reset filters completely with new types
        applyFilters();
        alert("Import DATA réussi !");
      } catch(e) {
        alert("Erreur import JSON: " + e.message);
      }
    }

    function importRELATIONS(){
      const jsonStr = prompt("Collez le tableau JSON des relations (format identique à RELATIONS) :");
      if(!jsonStr) return;
      try {
        const parsed = JSON.parse(jsonStr);
        if(!Array.isArray(parsed)) throw new Error("Format invalide: doit être un tableau");
        RELATIONS = parsed;
        if(APP.currentView === 'network') renderNetwork();
        alert("Import RELATIONS réussi !");
      } catch(e) {
        alert("Erreur import JSON: " + e.message);
      }
    }

    // =========================
    // 10) UTILS
    // =========================
    function getActorColor(type){
      const palette = {
        OEM: "#2563eb", Tier1: "#16a34a", Tier2: "#f59e0b",
        Battery: "#7c3aed", Software: "#e11d48", Charging: "#0891b2",
        Mobility: "#4f46e5", Other: "#6b7280"
      };
      return palette[type] || "#6b7280";
    }

    function getRelationColor(relationType){
      if (relationType === "competes_with") return "#9ca3af";
      if (relationType === "supplies_to") return "#f59e0b";
      if (relationType === "integrates_with") return "#2563eb";
      if (relationType === "partner_of") return "#16a34a";
      if (relationType === "comparable_to") return "#8b5cf6";
      return "#94a3b8";
    }

    function getInitials(name){
      const parts = (name || "").trim().split(/\s+/).filter(Boolean);
      const first = parts[0] ? parts[0][0] : "A";
      const second = parts[1] ? parts[1][0] : (parts[0] && parts[0][1] ? parts[0][1] : "A");
      return (first + second).toUpperCase();
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function csvEscape(value){
      const s = String(value ?? "");
      if (s.includes('"') || s.includes(",") || s.includes("\n")) {
        return `"${s.replaceAll('"','""')}"`;
      }
      return s;
    }
  </script>
</body>
</html>
